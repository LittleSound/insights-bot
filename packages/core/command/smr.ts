import type { Bot } from 'grammy'
import { extractContentFromURL, newLoggerForModule, summarizeWithQuestionsAsSimplifiedChinese } from '~/share'

const log = newLoggerForModule('command/smr')

export function initCommand(bot: Bot) {
  bot.command('smr', async (ctx) => {
    if (!ctx.message) return
    if (!ctx.hasCommand('smr')) return

    const url = ctx.message.text.replace('/smr', '').trim()
    if (!url) {
      await ctx.reply('æ²¡æœ‰æ‰¾åˆ°é“¾æ¥ï¼Œå¯ä»¥å‘é€ä¸€ä¸ªæœ‰æ•ˆçš„é“¾æ¥å—ï¼Ÿç”¨æ³•ï¼š/smr <é“¾æ¥>')
      return
    }

    try {
      // eslint-disable-next-line no-new
      new URL(url)
    }
    catch (err) {
      log.error(err)
      await ctx.reply('ä½ å‘æ¥çš„é“¾æ¥æ— æ³•è¢«ç†è§£ï¼Œå¯ä»¥é‡æ–°å‘ä¸€ä¸ªè¯•è¯•ã€‚ç”¨æ³•ï¼š/smr <é“¾æ¥>')
      return
    }

    const loadingMessage = await ctx.reply('è¯·ç¨ç­‰ï¼Œé‡å­é€Ÿè¯»ä¸­...')
    try {
      const summarization = await summarizeInputURL(url)
      await ctx.reply(summarization, { parse_mode: 'HTML' })
    }
    catch (err) {
      log.error(err)
      ctx.api.editMessageText(loadingMessage.chat.id, loadingMessage.message_id, 'æš‚æ—¶ä¸æ”¯æŒé‡å­é€Ÿè¯»è¿™æ ·çš„å†…å®¹å‘¢ï¼Œå¯ä»¥æ¢ä¸ªåˆ«çš„é“¾æ¥è¯•è¯•ã€‚')
    }
  })

  bot.hears(/$(\/smr)|(\/smr ([^"]+))/g, async (ctx) => {
    if (!ctx.message || !ctx.message.text) return
    const url = ctx.message.text.replace('/smr ', '').trim()
    const summarization = await summarizeInputURL(url)
    await ctx.editMessageText(summarization, { parse_mode: 'HTML' })
  })
}

async function summarizeInputURL(url: string) {
  const article = await extractContentFromURL(url)
  const content = await summarizeWithQuestionsAsSimplifiedChinese(article.title, article.byline, article.textContent)
  return `<b><a href="${url}">${article.title}</a></b>\n${content}\n\n<em>ğŸ¤–ï¸ Generated by chatGPT</em>`
}
