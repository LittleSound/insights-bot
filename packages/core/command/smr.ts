import { extractContentFromURL } from '~/share'
import type { TgBot } from '~/share/types'

export function initCommand(bot: TgBot) {
  bot.command('smr', async (ctx) => {
    const url = ctx.message.text.replace('/smr ', '').trim()
    const loadingMessage = await ctx.reply('ËØ∑Á®çÁ≠âÔºåÈáèÂ≠êÈÄüËØª‰∏≠...')
    try {
      const summarization = await summarizeInputURL(url)
      await ctx.reply(summarization, { parse_mode: 'HTML' })
    }
    catch (err) {
      ctx.editMessageText('ÊöÇÊó∂‰∏çÊîØÊåÅÈáèÂ≠êÈÄüËØªËøôÊ†∑ÁöÑÂÜÖÂÆπÂë¢ÔºåÂèØ‰ª•Êç¢‰∏™Âà´ÁöÑÈìæÊé•ËØïËØï„ÄÇ')
    }
  })

  bot.hears(/$(\/smr)|(\/smr ([^"]+))/g, async (ctx) => {
    const url = ctx.message.text.replace('/smr ', '').trim()
    const summarization = await summarizeInputURL(url)
    await ctx.editMessageText(summarization, { parse_mode: 'HTML' })
  })
}

async function summarizeInputURL(url: string) {
  const article = await extractContentFromURL(url)
  const content = '' // TODO: Code for summarization
  return `<b><a href="${url}">${article.title}</a></b>\n${content}\n\n<em>ü§ñÔ∏è Generated by chatGPT</em>`
}
